<?xml version="1.0"?>

<!-- Boeing 737 MAX FCS -->
<!-- Copyright (c) 2024 Josh Davidson (Octal450) -->

<system name="B737: FCS">
	
	<property value="1">hydraulics/flt-control</property> <!-- Temporary -->
	
	<channel name="Libraries">
		
		<fcs_function name="hydraulics/authority-man"> <!-- Guesses based on pilot info -->
			<function>
				<table> <!-- At higher speeds its harder for the surface to move, this is taken into account -->
					<independentVar lookup="row">aero/qbar-psf</independentVar>
					<tableData>
						 40  1.0
						 90  0.8
						450  0.4
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<switch name="hydraulics/aileron-switch">
			<default value="/controls/flight/aileron"/>
			<!--test value="AP roll">
				AP on
			</test-->
		</switch>
		
		<switch name="hydraulics/elevator-switch">
			<default value="/controls/flight/elevator"/>
			<!--test value="AP pitch">
				AP on
			</test-->
		</switch>
		
		<pure_gain name="hydraulics/aileron-trim">
			<input>/controls/flight/aileron-trim</input>
			<gain>0.5</gain>
		</pure_gain>
		
		<switch name="hydraulics/aileron-power">
			<default value="0"/>
			<test value="0">
				hydraulics/flt-control eq 0
			</test>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-a-psi ge 2200
				/systems/hydraulics/sys-b-psi ge 2200
			</test>
		</switch>
		
		<switch name="hydraulics/elevator-power">
			<default value="0"/>
			<test value="0">
				hydraulics/flt-control eq 0
			</test>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-a-psi ge 2200
				/systems/hydraulics/sys-b-psi ge 2200
			</test>
		</switch>
		
		<switch name="hydraulics/rudder-power">
			<default value="0"/>
			<test value="0">
				hydraulics/flt-control eq 0
			</test>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-a-psi ge 2200
				/systems/hydraulics/sys-b-psi ge 2200
			</test>
		</switch>
	
	</channel>
	
	<channel name="Aileron L">
		
		<summer name="hydraulics/aileron-l/sum">
			<input>hydraulics/aileron-switch</input>
			<input>hydraulics/aileron-trim</input>
		</summer>
		
		<pure_gain name="hydraulics/aileron-l/man-cmd">
			<input>hydraulics/aileron-l/sum</input>
			<gain>hydraulics/authority-man</gain>
		</pure_gain>
		
		<lag_filter name="hydraulics/aileron-l/man">
			<input>hydraulics/aileron-l/man-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<switch name="hydraulics/aileron-l/switch">
			<default value="hydraulics/aileron-l/man"/>
			<test value="hydraulics/aileron-l/sum">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<fcs_function name="hydraulics/aileron-l/cmd-deg">
			<function>
				<table> <!-- 1 deg down at rest -->
					<independentVar lookup="row">hydraulics/aileron-l/switch</independentVar>
					<tableData>
						-1.00000 -20
						 0.00000   1
						 0.66666  15
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<switch name="hydraulics/aileron-l/rate">
			<default value="40"/> <!-- Pretending the controls are heavy -->
			<test value="80">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<switch name="hydraulics/aileron-l/lag">
			<default value="100"/>
			<test value="26.5">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<actuator name="hydraulics/aileron-l/final-actuator">
			<input>hydraulics/aileron-l/cmd-deg</input>
			<rate_limit>hydraulics/aileron-l/rate</rate_limit>
			<lag>hydraulics/aileron-l/lag</lag>
			<output>hydraulics/aileron-l/final-deg</output>
		</actuator>
		
		<pure_gain name="hydraulics/aileron-l/final-tab-gain">
			<input>hydraulics/aileron-l/final-actuator</input>
			<gain>-1.0</gain>
			<output>hydraulics/aileron-l/final-tab-deg</output>
		</pure_gain>
	
	</channel>
	
	<channel name="Aileron R">
		
		<summer name="hydraulics/aileron-r/sum">
			<input>hydraulics/aileron-switch</input>
			<input>hydraulics/aileron-trim</input>
		</summer>
		
		<pure_gain name="hydraulics/aileron-r/man-cmd">
			<input>hydraulics/aileron-r/sum</input>
			<gain>hydraulics/authority-man</gain>
		</pure_gain>
		
		<lag_filter name="hydraulics/aileron-r/man">
			<input>hydraulics/aileron-r/man-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<switch name="hydraulics/aileron-r/switch">
			<default value="hydraulics/aileron-r/man"/>
			<test value="hydraulics/aileron-r/sum">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<fcs_function name="hydraulics/aileron-r/cmd-deg">
			<function>
				<table> <!-- 1 deg down at rest -->
					<independentVar lookup="row">hydraulics/aileron-r/switch</independentVar>
					<tableData>
						-0.66666  15
						 0.00000   1
						 1.00000 -20
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<switch name="hydraulics/aileron-r/rate">
			<default value="40"/> <!-- Pretending the controls are heavy -->
			<test value="80">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<switch name="hydraulics/aileron-r/lag">
			<default value="100"/>
			<test value="26.5">
				hydraulics/aileron-power eq 1
			</test>
		</switch>
		
		<actuator name="hydraulics/aileron-r/final-actuator">
			<input>hydraulics/aileron-r/cmd-deg</input>
			<rate_limit>hydraulics/aileron-r/rate</rate_limit>
			<lag>hydraulics/aileron-r/lag</lag>
			<output>hydraulics/aileron-r/final-deg</output>
		</actuator>
		
		<pure_gain name="hydraulics/aileron-r/final-tab-gain">
			<input>hydraulics/aileron-r/final-actuator</input>
			<gain>-1.0</gain>
			<output>hydraulics/aileron-r/final-tab-deg</output>
		</pure_gain>
	
	</channel>
	
	<channel name="Elevator L">
		
		<pure_gain name="hydraulics/elevator-l/man-cmd">
			<input>hydraulics/elevator-switch</input>
			<gain>hydraulics/authority-man</gain>
		</pure_gain>
		
		<lag_filter name="hydraulics/elevator-l/man">
			<input>hydraulics/elevator-l/man-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<switch name="hydraulics/elevator-l/switch">
			<default value="hydraulics/elevator-l/man"/>
			<test value="hydraulics/elevator-switch">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<pure_gain name="hydraulics/elevator-l/cmd-deg">
			<input>hydraulics/elevator-l/switch</input>
			<gain>24.3</gain>
			<clipto>
				<min>-24.3</min>
				<max>18.1</max>
			</clipto>
		</pure_gain>
		
		<switch name="hydraulics/elevator-l/tab-gain">
			<default value="-1"/> <!-- Balance mode -->
			<test logic="AND" value="1"> <!-- Anti-balance mode -->
				hydraulics/elevator-power eq 1
				fcs/flap-pos-deg ge 0.5
			</test>
		</switch>
		
		<lag_filter name="hydraulics/elevator-l/tab-gain-lag">
			<input>hydraulics/elevator-l/tab-gain</input>
			<c1>10</c1>
		</lag_filter>
		
		<switch name="hydraulics/elevator-l/rate">
			<default value="40"/> <!-- Pretending the controls are heavy -->
			<test logic="AND" value="75"> <!-- Anti-balance makes it slower -->
				hydraulics/elevator-power eq 1
				hydraulics/elevator-l/tab-gain eq 1
			</test>
			<test value="80">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<switch name="hydraulics/elevator-l/lag">
			<default value="100"/>
			<test value="26.5">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<actuator name="hydraulics/elevator-l/final-actuator">
			<input>hydraulics/elevator-l/cmd-deg</input>
			<rate_limit>hydraulics/elevator-l/rate</rate_limit>
			<lag>hydraulics/elevator-l/lag</lag>
			<output>hydraulics/elevator-l/final-deg</output>
		</actuator>
		
		<pure_gain name="hydraulics/elevator-l/final-tab-gain">
			<input>hydraulics/elevator-l/final-actuator</input>
			<gain>hydraulics/elevator-l/tab-gain-lag</gain>
			<output>hydraulics/elevator-l/final-tab-deg</output>
		</pure_gain>
	
	</channel>
	
	<channel name="Elevator R">
		
		<pure_gain name="hydraulics/elevator-r/man-cmd">
			<input>hydraulics/elevator-switch</input>
			<gain>hydraulics/authority-man</gain>
		</pure_gain>
		
		<lag_filter name="hydraulics/elevator-r/man">
			<input>hydraulics/elevator-r/man-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<switch name="hydraulics/elevator-r/switch">
			<default value="hydraulics/elevator-r/man"/>
			<test value="hydraulics/elevator-switch">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<pure_gain name="hydraulics/elevator-r/cmd-deg">
			<input>hydraulics/elevator-r/switch</input>
			<gain>24.3</gain>
			<clipto>
				<min>-24.3</min>
				<max>18.1</max>
			</clipto>
		</pure_gain>
		
		<switch name="hydraulics/elevator-r/tab-gain">
			<default value="-1"/> <!-- Balance mode -->
			<test logic="AND" value="1"> <!-- Anti-balance mode -->
				hydraulics/elevator-power eq 1
				fcs/flap-pos-deg ge 0.5
			</test>
		</switch>
		
		<lag_filter name="hydraulics/elevator-r/tab-gain-rag">
			<input>hydraulics/elevator-r/tab-gain</input>
			<c1>10</c1>
		</lag_filter>
		
		<switch name="hydraulics/elevator-r/rate">
			<default value="40"/> <!-- Pretending the controls are heavy -->
			<test logic="AND" value="75"> <!-- Anti-balance makes it slower -->
				hydraulics/elevator-power eq 1
				hydraulics/elevator-r/tab-gain eq 1
			</test>
			<test value="80">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<switch name="hydraulics/elevator-r/lag">
			<default value="100"/>
			<test value="26.5">
				hydraulics/elevator-power eq 1
			</test>
		</switch>
		
		<actuator name="hydraulics/elevator-r/final-actuator">
			<input>hydraulics/elevator-r/cmd-deg</input>
			<rate_limit>hydraulics/elevator-r/rate</rate_limit>
			<lag>hydraulics/elevator-r/lag</lag>
			<output>hydraulics/elevator-r/final-deg</output>
		</actuator>
		
		<pure_gain name="hydraulics/elevator-r/final-tab-gain">
			<input>hydraulics/elevator-r/final-actuator</input>
			<gain>hydraulics/elevator-r/tab-gain-rag</gain>
			<output>hydraulics/elevator-r/final-tab-deg</output>
		</pure_gain>
	
	</channel>
	
	<channel name="Stabilizer"> <!-- No hydraulics -->
		
		<pure_gain name="hydraulics/stabilizer/cmd-deg">
			<input>/controls/flight/elevator-trim</input>
			<gain>12.9</gain>
			<clipto>
				<min>-12.9</min>
				<max>4.2</max>
			</clipto>
		</pure_gain>
		
		<lag_filter name="hydraulics/stabilizer/final-lag">
			<input>hydraulics/stabilizer/cmd-deg</input>
			<c1>23.2</c1>
			<output>hydraulics/stabilizer/final-deg</output>
		</lag_filter>
	
	</channel>

</system>
